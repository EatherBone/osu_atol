![Ха ха asol](https://i.ibb.co/wZSRtB7k/asol.png)

[![osu! profile](https://img.shields.io/badge/osu!-eatherbone-ff66aa?logo=osu)](https://osu.ppy.sh/users/8335901)
[![Telegram](https://img.shields.io/badge/Telegram-@eatherboner-2CA5E0?logo=telegram)](https://t.me/eatherboner)
<br>ДАТЬ МУТУАЛ | ЗАБУСТИТЬ

# Печатаем инфо из osu! на ККТ Атол

Небольшой Python-скрипт, который соединяет [osu!](https://osu.ppy.sh/home) с кассовыми аппаратами (ККТ) АТОЛ. Скрипт в реальном времени отслеживает игровой процесс через [tosu!](https://github.com/tosuapp/tosu) и автоматически печатает чек с результатами после завершения каждой карты.
Зачем? Для чего? Я сам не знаю, просто посчитал что это круто.

## Как это работает?

Скрипт использует WebSocket для подключения к `tosu!`, которое, в свою очередь, читает данные напрямую из игры `osu!`. Логика работы следующая:

`osu! → tosu! Counter → tosu! App → WebSocket → Python Script → Драйвер АТОЛ → ККТ`

Скрипт отслеживает переход из игрового состояния (`Playing`) в экран результатов (`ResultsScreen`) и в этот момент отправляет собранные данные на печать.


### Необходиые компоненты

*   **Python 3.7+** ([скачать](https://www.python.org/downloads/)).
*   **Драйвер АТОЛ ДТО 10.x** ([скачать](https://fs.atol.ru/)).
*   **[osu!](https://osu.ppy.sh/home/download)**.
*   **Приложение [tosu!](https://github.com/tosuapp/tosu/releases)**.

## Установка и настройка

**Шаг 1: Установка зависимостей**

1.  Установи всё из абзаца выше.
2.  Убедись, что драйвер АТОЛ установлен, в диспетчере устройств определи COM-порт, к которому подключена касса (Их может быть два, но один всегда закрыт).
3.  Запусти `tosu!` и установи любой **Counter** из вкладки "Available" (например, `Simplistic`). **Без этого ничего не получится, я костыльщик!**
4.  Открой командную строку (cmd) или PowerShell и установи единственную Python-библиотеку:
    ```bash
    pip install websockets
    ```

**Шаг 2: Настройка**

1.  Склонируй этот репозиторий или скачай ZIP-архив.
2.  Помести все файлы (`osu_printer.py`, `libfptr10.py`, `atol_printer_config.json`) в одну папку.
3.  Открой файл `atol_printer_config.json` в текстовом редакторе и укажи номер COM-порта:

    ```json
    {
      "com_port": "COM5",
      "baud_rate": 115200
    }
    ```

## Запуск

Для корректной работы запусти всё в следующем порядке:

1.  Запусти **`tosu!`**.
2.  Запусти **`osu!`**.
3.  Открой командную строку в папке проекта и выполни команду:
    ```bash
    python osu_printer.py
    ```

После этого в консоли появятся сообщения о подключении к ККТ и `tosu!`. Играй, кайфуй. После завершения карты чек будет напечатан автоматически.

## Кастомизация и доп. возможности

Можно без проблем дополнить скрипт, чтобы добавить на чек больше информации. `tosu!` предоставляет много занятных данных.

<details>
<summary><b>Раскрой, чтобы увидеть список</b></summary>

### Данные игрового процесса (`gameplay.*`)
*   `gameplay.pp.fc`: **PP if FC** — сколько PP можно было получить за идеальное прохождение.
*   `gameplay.accuracy`: **Точность** в процентах.
*   `gameplay.combo.current` / `gameplay.combo.max`: Текущее и максимальное комбо за эту игровую сессию.
*   `gameplay.hits.300`, `100`, `50`: Количество попаданий "300", "100" и "50".
*   `gameplay.hits.0`: Количество **промахов (misses)**.
*   `gameplay.hits.sliderBreaks`: Количество **слайдербрейков**.
*   `gameplay.hits.grade.current`: Текущий буквенный ранг (`A`, `S`, `SH`, `X`, `XH`).
*   `gameplay.unstableRate`: Показатель стабильности нажатий (**UR**).

### Данные о карте (`menu.bm.*`)
*   `menu.bm.metadata.mapper`: Никнейм создателя карты.
*   `menu.bm.stats.SR`: **Star Rating (SR)** - сложность карты в звездах. 
*   `menu.bm.stats.CS`, `AR`, `OD`, `HP`: Основные параметры карты (Circle Size, Approach Rate, Overall Difficulty, HP Drain).
*   `menu.bm.stats.BPM.min` / `BPM.max`: Минимальный и максимальный BPM на карте.
*   `menu.bm.stats.maxCombo`: Максимально возможное комбо на карте.
*   `menu.bm.time.mp3`: Общая длительность трека в миллисекундах.

**Чтобы добавить эти данные:**
1.  В функции `tosu_listener` добавь нужный токен в список `value` при подписке.
2.  Создай новую глобальную переменную для хранения этого значения.
3.  В цикле `async for` получай и сохраняй новое значение.
4.  Передай его в функцию `print_osu_receipt` и добавь в текст чека `receipt_text`.
5.  Готово - ты боец, борец, молодец,.

</details>

## А что могло пойти не так?

*   **В консоли нет логов после "Ожидание данных от игры"**:
    *   Убедись, что ты установил **Counter** в `tosu!`.
    *   Убедись, что `osu!` и `tosu!` запущены.
    *   Попробуй перезапустить `tosu!` и `osu!`.

*   **Ошибка "Не удалось подключиться к ККТ"**:
    *   Проверь правильность `com_port` в файле `atol_printer_config.json`.
    *   Убедись, что ККТ подключена к компьютеру и включена.
    *   Проверь, установлены ли драйверы АТОЛ ДТО 10.
